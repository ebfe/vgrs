VPATH := %VPATH%

RUSTC ?= rustc
RUST_DIRS := -L .

VALGRIND ?= valgrind

RUSTC_CMD := $(RUSTC) $(RUST_DIRS) -O $(RUSTFLAGS)
VALGRIND_CMD := $(VALGRIND) -q --log-file=/dev/null

LIB_TOP_SRC := $(VPATH)/src/lib.rs
LIB_ALL_SRC := $(shell find $(VPATH)/src -type f -name '*.rs')
LIB         := $(shell $(RUSTC) --crate-file-name "$(LIB_TOP_SRC)")

.PHONY: all
all: $(LIB)

$(LIB): $(LIB_ALL_SRC)
	$(RUSTC_CMD) $(LIB_TOP_SRC)

TEST_TOOLS = valgrind memcheck

define DEF_TEST
vgrs-$(1)-test: $$(VPATH)/test/$(1).rs $$(LIB)
	$$(RUSTC_CMD) $$<
endef

$(foreach tool,$(TEST_TOOLS),\
$(eval $(call DEF_TEST,$(tool))))

.PHONY: check
check: $(foreach tool,$(TEST_TOOLS),vgrs-$(tool)-test)
	$(VALGRIND_CMD) --tool=none ./vgrs-valgrind-test
	$(VALGRIND_CMD) --tool=memcheck ./vgrs-memcheck-test

.PHONY: clean
clean:
	rm -f *.o *.a *.so *.dylib *.dll *.rlib *-test
